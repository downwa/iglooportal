#!/bin/bash

ip=$1
[ "$ip" = "" ] && echo "Missing IP address" 1>&2 && exit 1

ARP=/usr/sbin/arp
source /etc/iglooportal

# Extract MAC address from arp table
arpmac() {
        ip=$1
        $ARP -an | grep -v "<incomplete>" | grep ".*($ip)" | sed -e 's/.*(.*).*at.*\([0-9a-f][0-9a-f]:[0-9a-f][0-9a-f]:[0-9a-f][0-9a-f]:[0-9a-f][0-9a-f]:[0-9a-f][0-9a-f]:[0-9a-f][0-9a-f]\) .*/\1/g' | head -n 1
}

# Retrieve MAC address.  If not in arp table, ping to get it there.
mac() {
        ip=$1
        mac=$(arpmac "$ip")
        if [ "$mac" = "" ]; then # If not found the first time may have timed out or never been accessed before
                ping -c 1 -f -w 0 -W 1 "$ip" >/dev/null 2>&1 # Bring into arp table
                #arping -w 0 -c 1 -I br0 "$ip" >/dev/null # Bring into arp table
                mac=$(arpmac "$ip")
        fi
}

main() {
	ip=$1
	[ "$mac" = "" ] && mac "$ip"
	[ "$mac" = "" ] && echo "IP address $ip does not translate to a MAC address." 1>&2 && exit 2

	already=$(ps waxf | grep "ssh www-data@$AUTHSRVR relay-auth $ip $mac" | grep -v grep | wc -l)
	echo "relay-auth: ip=$ip,mac=$mac,already=$already"
	if [ "$already" = "0" ]; then
		result=$(ssh www-data@$AUTHSRVR relay-auth "$ip" "$mac" | grep -vi "awaiting")
		auth=$(echo "$result" | awk '{print $1}')
		echo "auth=$auth."
		if [ "$auth" = "TRUE" ]; then
			user=$(echo "$result" | cut -d "'" -f 2)
			echo /usr/bin/loginip "$ip" "$mac" "$user"
			/usr/bin/loginip "$ip" '' "$user"
		fi
	fi
}

# Rename duplicate logs
for((x=9; x>=0; x--)); do
	y=$((x+1))
	mv /var/log/relay-auth-$ip.log.$x /var/log/relay-auth-$ip.log.$y
done
mv /var/log/relay-auth-$ip.log /var/log/relay-auth-$ip.log.0
main "$ip" >/var/log/relay-auth-$ip.log 2>&1
