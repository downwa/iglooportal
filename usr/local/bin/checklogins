#!/bin/bash
# PURPOSE: Determine if any user currently authorized in firewall should actually be
#          de-authorized (logged out) e.g. due to being disabled, over usage, or other reason
#	   as determined by the authentication server.

source /etc/iglooportal # AUTHSRVR,CHECKOUT

macip=$(echo $(ifconfig eth0 | egrep "inet addr:|HWaddr" | cut -d ':' -f 2-) | awk '{print $3" "$4}')
users=$(ssh www-data@$AUTHSRVR /usr/local/bin/activeusers $macip)
iptables -t nat -L auth 2>&1 | grep -q "iptables: No chain/target/match by that name." && {
	date +"%D %T: Restarting firewall because it was down."
	/etc/init.d/iglooportal start
}
iptables -t nat -L auth | grep "MAC " | awk '{print $7" "$9}' | sed -e 's/USER://g' | while read mac user; do
	[ "${user:0:6}" = "micros" ] && continue
	echo "$users" | grep -q "^$user$" || {
		/usr/bin/logoutmac "$mac" "$user"
	}
done

