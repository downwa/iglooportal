#!/bin/bash

IPTABLES=/sbin/iptables
ARP=/usr/sbin/arp
USERS=/var/lib/iglooportal/users.txt
QUOTA=104857600 # 100 Mb
AUTHURL="https://wifi.choggiung.com/auth.php"

source /etc/iglooportal # AUTHSRVR

ip=$1
[ "$ip" = "" ] && echo "Missing IP address" 1>&2 && exit 1
mac=$2
user=$3

# Extract MAC address from arp table
arpmac() {
	ip=$1
	$ARP -an | grep -v "<incomplete>" | grep ".*($ip)" | sed -e 's/.*(.*).*at.*\([0-9a-f][0-9a-f]:[0-9a-f][0-9a-f]:[0-9a-f][0-9a-f]:[0-9a-f][0-9a-f]:[0-9a-f][0-9a-f]:[0-9a-f][0-9a-f]\) .*/\1/g' | head -n 1
}

# Retrieve MAC address.  If not in arp table, ping to get it there.
mac() {
	ip=$1
	mac=$(arpmac "$ip")
	if [ "$mac" = "" ]; then # If not found the first time may have timed out or never been accessed before
		ping -c 1 -f -w 0 -W 1 "$ip" >/dev/null 2>&1 # Bring into arp table
		#arping -w 0 -c 1 -I br0 "$ip" >/dev/null # Bring into arp table
		mac=$(arpmac "$ip")
	fi
}

[ "$mac" = "" ] && mac "$ip"
[ "$mac" = "" ] && echo "IP address $ip does not translate to a MAC address." 1>&2 && exit 2

#/usr/bin/rmtrack "$ip"

tries=0
while [ true ]; do
	$IPTABLES -n -t nat -L auth | grep -qi "MAC.*$mac.*USER:$user \*\/$" || { echo "MAC address $mac is not authorized."; break; }

	echo $IPTABLES -t nat -D auth -m mac --mac-source $mac --src $ip -j serv -m comment --comment "USER:$user" #--quota $QUOTA
	$IPTABLES -t nat -D auth -m mac --mac-source $mac --src $ip -j serv -m comment --comment "USER:$user" #--quota $QUOTA
	echo $IPTABLES -t nat -D auth -m mac --mac-source $mac -j serv -m comment --comment "USER:$user" #--quota $QUOTA
	$IPTABLES -t nat -D auth -m mac --mac-source $mac -j serv -m comment --comment "USER:$user" #--quota $QUOTA
	tries=$((tries+1))
	[ "$tries" -gt 10 ] && break # Hopeless
done

/usr/bin/rmtrack "$ip"

grep -vi ",$mac," "$USERS" >"$USERS.$$"
mv "$USERS.$$" "$USERS"

#ssh www-data@$AUTHSRVR logoutwebuser "$user"
session=$(find /var/lib/iglooportal/sessions/session-* -exec grep -H "^user=$user$" {} \; | head -n 1 | cut -d ':' -f 1)
pass=$(grep "^pass=" "$session" | cut -d '=' -f 2)
echo curl --show-error --silent --insecure "$AUTHURL?user=$user&pass=$pass&ipaddr=&macaddr="
curl --show-error --silent --insecure "$AUTHURL?user=$user&pass=$pass&ipaddr=&macaddr=" | grep -v OK
